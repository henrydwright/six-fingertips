@page
@model IndexModel
@{
    ViewData["Title"] = "AI Assistant";
}

<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full-width">
        <h1 class="nhsuk-heading-l">What is your question?</h1>
        @if (!ModelState.IsValid)
        {
            <div class="nhsuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1">
                <h2 class="nhsuk-error-summary__title" id="error-summary-title">
                    There is a problem
                </h2>
                <div class="nhsuk-error-summary__body">
                    <p>An error occurred while processing your request. Please try again.</p>
                    <ul class="nhsuk-list nhsuk-error-summary__list">
                        @foreach (var modelError in ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <li>
                                @modelError.ErrorMessage
                            </li>
                        }
                    </ul>
                </div>
            </div>
        }
        <form method="post" id="questionForm">
            @Html.AntiForgeryToken()
            <div class="nhsuk-form-group @(ModelState["InputText"]?.Errors.Count > 0 ? "nhsuk-form-group--error" : "")">
            <label class="nhsuk-label" for="input-text">
                Enter your question
            </label>
            <div class="nhsuk-hint" id="input-text-hint">
                For best results ensure your question is specific and includes mention of the GP practice(s), PCN(s) or council areas you are interested in.
            </div>
            @if (ModelState["InputText"]?.Errors?.Count > 0)
            {
                <span class="nhsuk-error-message" id="input-text-error">
                <span class="nhsuk-u-visually-hidden">Error:</span> @ModelState["InputText"]?.Errors[0]?.ErrorMessage
                </span>
            }
            <textarea 
                class="nhsuk-textarea @(ModelState["InputText"]?.Errors.Count > 0 ? "nhsuk-textarea--error" : "")" 
                id="input-text" 
                name="InputText" 
                rows="5" 
                aria-describedby="input-text-hint @(ModelState["InputText"]?.Errors.Count > 0 ? "input-text-error" : "")"
                asp-for="InputText"></textarea>
            </div>

            <button class="nhsuk-button" data-module="nhsuk-button" type="submit">
            Send
            </button>
        </form>
        <details class="nhsuk-details">
            <summary class="nhsuk-details__summary">
                <span class="nhsuk-details__summary-text">
                See example questions you can ask
                </span>
            </summary>
            <div class="nhsuk-details__text">
                <p>Try asking...</p>
                <ul>
                    <li>"What smoking indicators are available at an ICB level?"</li> 
                    <li>"Give me summary information for Anytown GP Practice"</li>
                    <li>"Tell me the year 6 obesity levels for England and Oxfordshire"</li>
                    <li>"Make me a bar graph showing the female population breakdown by age at Anywhere Health Centre"</li>
                </ul> 
            </div>
        </details>
    </div>
    
</div>
<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full-width">
        <h2 class="nhsuk-heading-m">Response</h2>
        <div id="loadingMessage" style="display: none;" class="nhsuk-card nhsuk-card--feature">
            <div class="nhsuk-card__content">
                <h2 class="nhsuk-card__heading nhsuk-heading-m">Processing your request</h2>
                <div class="nhsuk-card__description">
                    <p class="nhsuk-body">Please wait while we generate your response...</p>
                </div>
            </div>
        </div>
        @if (!string.IsNullOrEmpty(Model.AgentResponse))
        {
            <div class="nhsuk-card nhsuk-card--feature" id="responseCard">
                <div class="nhsuk-card__content">
                    <div class="nhsuk-card__description">
                        @if (!string.IsNullOrEmpty(Model.AgentResponseHtml))
                        {
                            <div class="markdown-content">
                                @Html.Raw(Model.AgentResponseHtml)
                            </div>
                        }
                        else
                        {
                            <p class="nhsuk-body">@Model.AgentResponse</p>
                        }
                    </div>
                </div>
            </div>
        }
        else
        {
            <p id="responseAppearSoonText"><i>Your response will appear here.</i></p>
        }
    </div>
</div>
<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full-width">
        <h2 class="nhsuk-heading-m">Actions Performed</h2>
        @if (Model.ApiCalls != null) {
            <p>This section lists all the actions the AI performed outside of its internal thought process. For example using the Fingertips API or creating and running Python code.</p>
            @foreach (var apiCall in Model.ApiCalls)
            {
                <details class="nhsuk-details nhsuk-expander">
                    <summary class="nhsuk-details__summary">
                        <span class="nhsuk-details__summary-text">
                        @Model.GetFingertipsFunctionFriendlyName(apiCall.Name)
                        </span>
                    </summary>
                    <div class="nhsuk-details__text">
                        <table class="nhsuk-table">
                            <caption class="nhsuk-table__caption">Arguments</caption>
                            <thead class="nhsuk-table__head">
                                <tr>
                                    <th scope="col" class="nhsuk-table__header">Argument</th>
                                    <th scope="col" class="nhsuk-table__header">Value</th>
                                </tr>
                            </thead>
                            <tbody class="nhsuk-table__body">
                                @foreach (string argName in apiCall.Arguments.Keys) {
                                    <tr class="nhsuk-table__row">
                                        <td class="nhsuk-table__cell">
                                            @Model.GetFingertipsArgumentNameFriendlyName(argName) (@argName)
                                        </td>
                                        <td class="nhsuk-table__cell">
                                            @Model.GetFingertipsArgumentValueFriendlyName(argName, apiCall.Arguments[argName])
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                        <details class="nhsuk-details">
                        <summary class="nhsuk-details__summary">
                            <span class="nhsuk-details__summary-text">
                            Raw Output (in JSON format)
                            </span>
                        </summary>
                            <div class="nhsuk-details__text">
                                <code>@apiCall.Output</code>
                            </div>
                        </details>
                    </div>
                </details>
            }
        } else {
            <p><i>The actions the AI performed outside its internal thought process (e.g. Fingertips API use or writing and running code) will appear here.</i></p>
        }
    </div>
</div>
<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full-width">
        <h2 class="nhsuk-heading-m">When will the site stop working?</h2>
        <p>To avoid being bankrupted, this site will stop after a certain amount of money is spent on the underlying GPT-4o-mini model.</p>
        <p>When you run a query, the total token usage and % budget used will be displayed below:</p>
    </div>
</div>
        @if (!String.IsNullOrEmpty(Model.PercentBudgetUsed))
        {
    <div class="nhsuk-grid-row">
        <div class="nhsuk-grid-column-one-half">
            <div class="nhsuk-card">
                <div class="nhsuk-card__content">
                    <h3 class="nhsuk-card__heading">@Model.PercentBudgetUsed&percnt;</h3>
                    <p class="nhsuk-card__description">project budget used</p>
                </div>
            </div>
        </div>
        <div class="nhsuk-grid-column-one-half">
            <div class="nhsuk-card">
                <div class="nhsuk-card__content">
                    <h3 class="nhsuk-card__heading">@Model.TotalTokensUsed</h3>
                    <p class="nhsuk-card__description">tokens used</p>
                </div>
            </div>
        </div>
    </div>
        }
<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full-width">
        <h2 class="nhsuk-heading-m">How does this site work?</h2>
        <p class="nhsuk-body">
            This site uses an Azure AI Foundry Agent based on GPT-4o-mini with access to 1) a subset of methods in the <a href="https://fingertips.phe.org.uk/">Fingertips</a> API and 2) a code interpreter to provide responses to natural language queries based on public health data.
        </p>
        <p class="nhsuk-body">
        I used AI (specifically Cursor and Github Copilot) to help me code this site. My experience of writing code with AI assistance is documented in this blog post from June 2025.
        </p>
        <p>
            This site uses public sector information licensed under the Open Government Licence v3.0. Fingertips data is courtesy of Office for Health Improvement and Disparities. Public health profiles. 2025 https://fingertips.phe.org.uk/ © Crown copyright 2025</p>
        </p>
        <h2 class="nhsuk-heading-m">What are the limitations of this site?</h2>
        <p class="nhsuk-body">
            This is a piece of demonstration software, it has not been thoroughly tested and should not be relied upon for giving correct answers. 
        </p>
        <p class="nhsuk-body">
            The agent only has access to a limited subset of Fingertips data, namely: profiles for smoking, obesity, diabetes, alcohol and dementia; GP and PCN summary data (including population breakdown); area code data (e.g. GP ODS codes, ONS codes); address data for GPs.
        </p>
        <p class="nhsuk-body">
            Like many large language models, the model can be poor at interpreting data it has retrieved and may hallucinate. Always check the answer you have been given.
        </p>
        <h2 class="nhsuk-heading-m">Where is my data sent?</h2>
        <p class="nhsuk-body">
            All user input is sent to a globally provisioned OpenAI <code>GPT-4o-mini</code> AI model hosted by Microsoft/OpenAI. This is the same as using a service like the free version of ChatGPT. User input will also be logged on the Azure Web App server that this site runs on.
        </p>
        <p class="nhsuk-body">
            <b>DO NOT</b> enter any sensitive information (personal, commercial or otherwise) to the prompt above. Aside from it being logged and visible to myself and Microsoft, this is a hobby website with best-efforts security. I take no responsibility for any loss occured as a result of using this website.
        </p>
        <h3 class="nhsuk-heading-s">Libraries used (with licenses if needed)</h3>
        <details class="nhsuk-details">
        <summary class="nhsuk-details__summary">
            <span class="nhsuk-details__summary-text">
            Azure SDK for .NET
            </span>
        </summary>
            <div class="nhsuk-details__text">
                <code>
                The MIT License (MIT)<br/>
                <br/>
                Copyright (c) 2015 Microsoft<br/>
                <br/>
                Permission is hereby granted, free of charge, to any person obtaining a copy
                of this software and associated documentation files (the "Software"), to deal
                in the Software without restriction, including without limitation the rights
                to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                copies of the Software, and to permit persons to whom the Software is
                furnished to do so, subject to the following conditions:<br/>
                <br/>
                The above copyright notice and this permission notice shall be included in all
                copies or substantial portions of the Software.<br/>
                <br/>
                THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
                SOFTWARE.
                </code>
            </div>
        </details>
        <details class="nhsuk-details">
        <summary class="nhsuk-details__summary">
            <span class="nhsuk-details__summary-text">
            NHS Frontend
            </span>
        </summary>
            <div class="nhsuk-details__text">
                <code>
                MIT License<br/>
                <br/>
                Copyright (c) 2019 NHS Digital<br/>
                <br/>
                Permission is hereby granted, free of charge, to any person obtaining a copy
                of this software and associated documentation files (the "Software"), to deal
                in the Software without restriction, including without limitation the rights
                to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
                copies of the Software, and to permit persons to whom the Software is
                furnished to do so, subject to the following conditions:<br/>
                <br/>
                The above copyright notice and this permission notice shall be included in all
                copies or substantial portions of the Software.<br/>
                <br/>
                THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
                SOFTWARE.
                </code>
            </div>
        </details>
        <details class="nhsuk-details">
        <summary class="nhsuk-details__summary">
            <span class="nhsuk-details__summary-text">
            Markdig
            </span>
        </summary>
            <div class="nhsuk-details__text">
                <code>
                Copyright (c) 2018-2019, Alexandre Mutel<br/>
                All rights reserved.<br/>
                <br/>
                Redistribution and use in source and binary forms, with or without modification
                , are permitted provided that the following conditions are met:<br/>
                <br/>
                1. Redistributions of source code must retain the above copyright notice, this 
                list of conditions and the following disclaimer.<br/>
                <br/>
                2. Redistributions in binary form must reproduce the above copyright notice, 
                this list of conditions and the following disclaimer in the documentation 
                and/or other materials provided with the distribution.<br/>
                <br/>
                THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
                ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
                WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE 
                DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
                FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
                DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR 
                SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER 
                CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
                OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE 
                OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
                </code>
            </div>
        </details>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('questionForm');
        const loadingMessage = document.getElementById('loadingMessage');
        const responseCard = document.getElementById('responseCard');
        const responseAppearsHereText = document.getElementById('responseAppearSoonText');

        form.addEventListener('submit', function() {
            if (responseCard) {
                responseCard.style.display = 'none';
            }
            if (responseAppearsHereText) {
                responseAppearsHereText.style.display = 'none';
            }
            loadingMessage.style.display = 'block';
        });
    });
</script>

<style>
    .markdown-content {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    .markdown-content h1, .markdown-content h2, .markdown-content h3, 
    .markdown-content h4, .markdown-content h5, .markdown-content h6 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
    }
    .markdown-content p {
        margin-bottom: 1em;
    }
    .markdown-content code {
        background-color: #f0f0f0;
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-family: monospace;
    }
    .markdown-content pre {
        background-color: #f0f0f0;
        padding: 1em;
        border-radius: 3px;
        overflow-x: auto;
    }
    .markdown-content pre code {
        background-color: transparent;
        padding: 0;
    }
    .markdown-content ul, .markdown-content ol {
        margin-bottom: 1em;
        padding-left: 2em;
    }
    .markdown-content blockquote {
        border-left: 4px solid #ccc;
        margin: 1em 0;
        padding-left: 1em;
        color: #666;
    }
    .markdown-content table {
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 1em;
    }
    .markdown-content th, .markdown-content td {
        border: 1px solid #ddd;
        padding: 8px;
    }
    .markdown-content th {
        background-color: #f5f5f5;
    }
    .markdown-content img {
        max-width: 90%;
    }
</style>
