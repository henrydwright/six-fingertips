@page
@model IndexModel
@{
    ViewData["Title"] = "AI Assistant";
}

<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full-width">
        <h1 class="nhsuk-heading-l">What is your question?</h1>
        @if (!ModelState.IsValid)
        {
            <div class="nhsuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1">
                <h2 class="nhsuk-error-summary__title" id="error-summary-title">
                    There is a problem
                </h2>
                <div class="nhsuk-error-summary__body">
                    <p>An error occurred while processing your request. Please try again.</p>
                    <ul class="nhsuk-list nhsuk-error-summary__list">
                        @foreach (var modelError in ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <li>
                                @modelError.ErrorMessage
                            </li>
                        }
                    </ul>
                </div>
            </div>
        }
        <form method="post" id="questionForm">
            <div class="nhsuk-form-group @(ModelState["InputText"]?.Errors.Count > 0 ? "nhsuk-form-group--error" : "")">
                <label class="nhsuk-label" for="input-text">
                    Enter your question
                </label>
                <div class="nhsuk-hint" id="input-text-hint">
                    For best results ensure your question is specific and includes mention of the GP practice(s), PCN(s) or geographical areas you are interested in.
                </div>
                @if (ModelState["InputText"]?.Errors?.Count > 0)
                {
                    <span class="nhsuk-error-message" id="input-text-error">
                        <span class="nhsuk-u-visually-hidden">Error:</span> @ModelState["InputText"]?.Errors[0]?.ErrorMessage
                    </span>
                }
                <textarea 
                    class="nhsuk-textarea @(ModelState["InputText"]?.Errors.Count > 0 ? "nhsuk-textarea--error" : "")" 
                    id="input-text" 
                    name="InputText" 
                    rows="5" 
                    aria-describedby="input-text-hint @(ModelState["InputText"]?.Errors.Count > 0 ? "input-text-error" : "")"
                    asp-for="InputText"></textarea>
            </div>

            <button class="nhsuk-button" data-module="nhsuk-button" type="submit">
                Send
            </button>
        </form>

        <div id="loadingMessage" style="display: none;" class="nhsuk-card nhsuk-card--feature">
            <div class="nhsuk-card__content">
                <h2 class="nhsuk-card__heading nhsuk-heading-m">Processing your request</h2>
                <div class="nhsuk-card__description">
                    <p class="nhsuk-body">Please wait while we generate your response...</p>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(Model.AgentResponse))
        {
            <div class="nhsuk-card nhsuk-card--feature" id="responseCard">
                <div class="nhsuk-card__content">
                    <h2 class="nhsuk-card__heading nhsuk-heading-m">Response</h2>
                    <div class="nhsuk-card__description">
                        @if (!string.IsNullOrEmpty(Model.AgentResponseHtml))
                        {
                            <div class="markdown-content">
                                @Html.Raw(Model.AgentResponseHtml)
                            </div>
                        }
                        else
                        {
                            <p class="nhsuk-body">@Model.AgentResponse</p>
                        }
                    </div>
                </div>
            </div>
        }
        <div class="nhsuk-inset-text">
        <p><b>Hint:</b> Try asking "What smoking indicators are available at an ICB level?" "Give me summary information for Anytown GP Practice" "Tell me the year 6 obesity levels for England and Oxfordshire"</p>
        </div>
        <h2 class="nhsuk-heading-m">When will the site stop working?</h2>
    <p>To avoid being bankrupted, this site will stop after a certain amount of money is spent on the underlying GPT-4o-mini model. When you run a query, the total token usage and % budget used will be displayed below:</p>
    @if (!String.IsNullOrEmpty(Model.PercentBudgetUsed))
    {
        <div class="nhsuk-card">
            <div class="nhsuk-card__content">
                <h3 class="nhsuk-card__heading">@Model.PercentBudgetUsed&percnt;</h3>
                <p class="nhsuk-card__description">project budget used</p>
            </div>
        </div>
        <div class="nhsuk-card">
            <div class="nhsuk-card__content">
                <h3 class="nhsuk-card__heading">@Model.TotalTokensUsed</h3>
                <p class="nhsuk-card__description">tokens used</p>
            </div>
        </div>
    }
    <h2 class="nhsuk-heading-m">How does this site work?</h2>
    <p class="nhsuk-body">
        This site uses an Azure AI Foundry Agent based on GPT-4o-mini with access to 1) a subset of methods in the <a href="https://fingertips.phe.org.uk/">Fingertips</a> API and 2) a code interpreter to provide responses to natural language queries based on public health data.
    </p>
     <p class="nhsuk-body">
      I used AI (specifically Cursor) to help me code this site. My experience of writing code with AI assistance is documented in this blog post from June 2025.
    </p>
    <p>
        This site uses public sector information licensed under the Open Government Licence v3.0. Fingertips data is courtesy of Office for Health Improvement and Disparities. Public health profiles. 2025 https://fingertips.phe.org.uk/ © Crown copyright 2025</p>
    </p>
    <h2 class="nhsuk-heading-m">What are the limitations of this site?</h2>
    <p class="nhsuk-body">
        This is a piece of demonstration software, it has not been thoroughly tested and should not be relied upon for giving correct answers. 
    </p>
    <p class="nhsuk-body">
        The agent only has access to a limited subset of Fingertips data, namely: profiles for smoking, obesity, diabetes, alcohol and dementia; GP and PCN summary data (including population breakdown); area code data (e.g. GP ODS codes, ONS codes); address data for GPs.
    </p>
    <p class="nhsuk-body">
        Like many large language models, the model can be poor at interpreting data it has retrieved and may hallucinate. Always check the answer you have been given.
    </p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('questionForm');
        const loadingMessage = document.getElementById('loadingMessage');
        const responseCard = document.getElementById('responseCard');

        form.addEventListener('submit', function() {
            if (responseCard) {
                responseCard.style.display = 'none';
            }
            loadingMessage.style.display = 'block';
        });
    });
</script>

<style>
    .markdown-content {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    .markdown-content h1, .markdown-content h2, .markdown-content h3, 
    .markdown-content h4, .markdown-content h5, .markdown-content h6 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
    }
    .markdown-content p {
        margin-bottom: 1em;
    }
    .markdown-content code {
        background-color: #f0f0f0;
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-family: monospace;
    }
    .markdown-content pre {
        background-color: #f0f0f0;
        padding: 1em;
        border-radius: 3px;
        overflow-x: auto;
    }
    .markdown-content pre code {
        background-color: transparent;
        padding: 0;
    }
    .markdown-content ul, .markdown-content ol {
        margin-bottom: 1em;
        padding-left: 2em;
    }
    .markdown-content blockquote {
        border-left: 4px solid #ccc;
        margin: 1em 0;
        padding-left: 1em;
        color: #666;
    }
    .markdown-content table {
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 1em;
    }
    .markdown-content th, .markdown-content td {
        border: 1px solid #ddd;
        padding: 8px;
    }
    .markdown-content th {
        background-color: #f5f5f5;
    }
</style>
